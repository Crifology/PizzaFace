!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).WaveformData=e()}(this,(function(){"use strict";function t(t,e){this._waveformData=t,this._channelIndex=e}t.prototype.min_sample=function(t){var e=2*(t*this._waveformData.channels+this._channelIndex);return this._waveformData._at(e)},t.prototype.max_sample=function(t){var e=2*(t*this._waveformData.channels+this._channelIndex)+1;return this._waveformData._at(e)},t.prototype.set_min_sample=function(t,e){var n=2*(t*this._waveformData.channels+this._channelIndex);return this._waveformData._set_at(n,e)},t.prototype.set_max_sample=function(t,e){var n=2*(t*this._waveformData.channels+this._channelIndex)+1;return this._waveformData._set_at(n,e)},t.prototype.min_array=function(){return this._waveformData._offsetValues(0,this._waveformData.length,2*this._channelIndex)},t.prototype.max_array=function(){return this._waveformData._offsetValues(0,this._waveformData.length,2*this._channelIndex+1)};var e=127,n=-128;function a(t){var a,s,r=t.scale,g=t.amplitude_scale,l=t.split_channels,i=t.length,o=t.sample_rate,I=t.channels.map((function(t){return new Float32Array(t)})),h=l?I.length:1,c=1===h?1:2,C=1===c?20:24,A=function(t,e){var n=Math.floor(t/e);return t-n*e>0&&n++,n}(i,r),u=new ArrayBuffer(C+2*A*h),m=new DataView(u),f=0,b=C,d=new Array(h),p=new Array(h);for(a=0;a<h;a++)d[a]=1/0,p[a]=-1/0;for(m.setInt32(0,c,!0),m.setUint32(4,1,!0),m.setInt32(8,o,!0),m.setInt32(12,r,!0),m.setInt32(16,A,!0),2===c&&m.setInt32(20,h,!0),s=0;s<i;s++){var W=0;if(1===h){for(a=0;a<I.length;++a)W+=I[a][s];(W=Math.floor(e*W*g/I.length))<d[0]&&(d[0]=W,d[0]<n&&(d[0]=n)),W>p[0]&&(p[0]=W,p[0]>e&&(p[0]=e))}else for(a=0;a<h;++a)(W=Math.floor(e*I[a][s]*g))<d[a]&&(d[a]=W,d[a]<n&&(d[a]=n)),W>p[a]&&(p[a]=W,p[a]>e&&(p[a]=e));if(++f===r){for(a=0;a<h;a++)m.setInt8(b++,d[a]),m.setInt8(b++,p[a]),d[a]=1/0,p[a]=-1/0;f=0}}if(f>0)for(a=0;a<h;a++)m.setInt8(b++,d[a]),m.setInt8(b++,p[a]);return u}function s(t){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},s(t)}var r=null;try{var g="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");r=g.Worker}catch(t){}function l(t,e,n){var a=void 0===e?null:e,s=function(t,e){return Buffer.from(t,"base64").toString(e?"utf16":"utf8")}(t,void 0!==n&&n),g=s.indexOf("\n",10)+1,l=s.substring(g)+(a?"//# sourceMappingURL="+a:"");return function(t){return new r(l,Object.assign({},t,{eval:!0}))}}function i(t,e,n){var a=void 0===e?null:e,s=function(t,e){var n=atob(t);if(e){for(var a=new Uint8Array(n.length),s=0,r=n.length;s<r;++s)a[s]=n.charCodeAt(s);return String.fromCharCode.apply(null,new Uint16Array(a.buffer))}return n}(t,void 0!==n&&n),r=s.indexOf("\n",10)+1,g=s.substring(r)+(a?"//# sourceMappingURL="+a:""),l=new Blob([g],{type:"application/javascript"});return URL.createObjectURL(l)}var o="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);var I,h,c,C=(I="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgLyoqCiAgICogQXVkaW9CdWZmZXItYmFzZWQgV2F2ZWZvcm1EYXRhIGdlbmVyYXRvcgogICAqCiAgICogQWRhcHRlZCBmcm9tIEJsb2NrRmlsZTo6Q2FsY1N1bW1hcnkgaW4gQXVkYWNpdHksIHdpdGggcGVybWlzc2lvbi4KICAgKiBTZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9hdWRhY2l0eS9zb3VyY2UvYnJvd3NlL2F1ZGFjaXR5LXNyYy90cnVuay9zcmMvQmxvY2tGaWxlLmNwcAogICAqLwogIHZhciBJTlQ4X01BWCA9IDEyNzsKICB2YXIgSU5UOF9NSU4gPSAtMTI4OwoKICBmdW5jdGlvbiBjYWxjdWxhdGVXYXZlZm9ybURhdGFMZW5ndGgoYXVkaW9fc2FtcGxlX2NvdW50LCBzY2FsZSkgewogICAgdmFyIGRhdGFfbGVuZ3RoID0gTWF0aC5mbG9vcihhdWRpb19zYW1wbGVfY291bnQgLyBzY2FsZSk7CiAgICB2YXIgc2FtcGxlc19yZW1haW5pbmcgPSBhdWRpb19zYW1wbGVfY291bnQgLSBkYXRhX2xlbmd0aCAqIHNjYWxlOwoKICAgIGlmIChzYW1wbGVzX3JlbWFpbmluZyA+IDApIHsKICAgICAgZGF0YV9sZW5ndGgrKzsKICAgIH0KCiAgICByZXR1cm4gZGF0YV9sZW5ndGg7CiAgfQoKICBmdW5jdGlvbiBnZW5lcmF0ZVdhdmVmb3JtRGF0YShvcHRpb25zKSB7CiAgICB2YXIgc2NhbGUgPSBvcHRpb25zLnNjYWxlOwogICAgdmFyIGFtcGxpdHVkZV9zY2FsZSA9IG9wdGlvbnMuYW1wbGl0dWRlX3NjYWxlOwogICAgdmFyIHNwbGl0X2NoYW5uZWxzID0gb3B0aW9ucy5zcGxpdF9jaGFubmVsczsKICAgIHZhciBsZW5ndGggPSBvcHRpb25zLmxlbmd0aDsKICAgIHZhciBzYW1wbGVfcmF0ZSA9IG9wdGlvbnMuc2FtcGxlX3JhdGU7CiAgICB2YXIgY2hhbm5lbHMgPSBvcHRpb25zLmNoYW5uZWxzLm1hcChmdW5jdGlvbiAoY2hhbm5lbCkgewogICAgICByZXR1cm4gbmV3IEZsb2F0MzJBcnJheShjaGFubmVsKTsKICAgIH0pOwogICAgdmFyIG91dHB1dF9jaGFubmVscyA9IHNwbGl0X2NoYW5uZWxzID8gY2hhbm5lbHMubGVuZ3RoIDogMTsKICAgIHZhciB2ZXJzaW9uID0gb3V0cHV0X2NoYW5uZWxzID09PSAxID8gMSA6IDI7CiAgICB2YXIgaGVhZGVyX3NpemUgPSB2ZXJzaW9uID09PSAxID8gMjAgOiAyNDsKICAgIHZhciBkYXRhX2xlbmd0aCA9IGNhbGN1bGF0ZVdhdmVmb3JtRGF0YUxlbmd0aChsZW5ndGgsIHNjYWxlKTsKICAgIHZhciB0b3RhbF9zaXplID0gaGVhZGVyX3NpemUgKyBkYXRhX2xlbmd0aCAqIDIgKiBvdXRwdXRfY2hhbm5lbHM7CiAgICB2YXIgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKHRvdGFsX3NpemUpOwogICAgdmFyIGRhdGFfdmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIpOwogICAgdmFyIHNjYWxlX2NvdW50ZXIgPSAwOwogICAgdmFyIG9mZnNldCA9IGhlYWRlcl9zaXplOwogICAgdmFyIGNoYW5uZWwsIGk7CiAgICB2YXIgbWluX3ZhbHVlID0gbmV3IEFycmF5KG91dHB1dF9jaGFubmVscyk7CiAgICB2YXIgbWF4X3ZhbHVlID0gbmV3IEFycmF5KG91dHB1dF9jaGFubmVscyk7CgogICAgZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IG91dHB1dF9jaGFubmVsczsgY2hhbm5lbCsrKSB7CiAgICAgIG1pbl92YWx1ZVtjaGFubmVsXSA9IEluZmluaXR5OwogICAgICBtYXhfdmFsdWVbY2hhbm5lbF0gPSAtSW5maW5pdHk7CiAgICB9CgogICAgZGF0YV92aWV3LnNldEludDMyKDAsIHZlcnNpb24sIHRydWUpOyAvLyBWZXJzaW9uCgogICAgZGF0YV92aWV3LnNldFVpbnQzMig0LCAxLCB0cnVlKTsgLy8gSXMgOCBiaXQ/CgogICAgZGF0YV92aWV3LnNldEludDMyKDgsIHNhbXBsZV9yYXRlLCB0cnVlKTsgLy8gU2FtcGxlIHJhdGUKCiAgICBkYXRhX3ZpZXcuc2V0SW50MzIoMTIsIHNjYWxlLCB0cnVlKTsgLy8gU2NhbGUKCiAgICBkYXRhX3ZpZXcuc2V0SW50MzIoMTYsIGRhdGFfbGVuZ3RoLCB0cnVlKTsgLy8gTGVuZ3RoCgogICAgaWYgKHZlcnNpb24gPT09IDIpIHsKICAgICAgZGF0YV92aWV3LnNldEludDMyKDIwLCBvdXRwdXRfY2hhbm5lbHMsIHRydWUpOwogICAgfQoKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICB2YXIgc2FtcGxlID0gMDsKCiAgICAgIGlmIChvdXRwdXRfY2hhbm5lbHMgPT09IDEpIHsKICAgICAgICBmb3IgKGNoYW5uZWwgPSAwOyBjaGFubmVsIDwgY2hhbm5lbHMubGVuZ3RoOyArK2NoYW5uZWwpIHsKICAgICAgICAgIHNhbXBsZSArPSBjaGFubmVsc1tjaGFubmVsXVtpXTsKICAgICAgICB9CgogICAgICAgIHNhbXBsZSA9IE1hdGguZmxvb3IoSU5UOF9NQVggKiBzYW1wbGUgKiBhbXBsaXR1ZGVfc2NhbGUgLyBjaGFubmVscy5sZW5ndGgpOwoKICAgICAgICBpZiAoc2FtcGxlIDwgbWluX3ZhbHVlWzBdKSB7CiAgICAgICAgICBtaW5fdmFsdWVbMF0gPSBzYW1wbGU7CgogICAgICAgICAgaWYgKG1pbl92YWx1ZVswXSA8IElOVDhfTUlOKSB7CiAgICAgICAgICAgIG1pbl92YWx1ZVswXSA9IElOVDhfTUlOOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHNhbXBsZSA+IG1heF92YWx1ZVswXSkgewogICAgICAgICAgbWF4X3ZhbHVlWzBdID0gc2FtcGxlOwoKICAgICAgICAgIGlmIChtYXhfdmFsdWVbMF0gPiBJTlQ4X01BWCkgewogICAgICAgICAgICBtYXhfdmFsdWVbMF0gPSBJTlQ4X01BWDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IG91dHB1dF9jaGFubmVsczsgKytjaGFubmVsKSB7CiAgICAgICAgICBzYW1wbGUgPSBNYXRoLmZsb29yKElOVDhfTUFYICogY2hhbm5lbHNbY2hhbm5lbF1baV0gKiBhbXBsaXR1ZGVfc2NhbGUpOwoKICAgICAgICAgIGlmIChzYW1wbGUgPCBtaW5fdmFsdWVbY2hhbm5lbF0pIHsKICAgICAgICAgICAgbWluX3ZhbHVlW2NoYW5uZWxdID0gc2FtcGxlOwoKICAgICAgICAgICAgaWYgKG1pbl92YWx1ZVtjaGFubmVsXSA8IElOVDhfTUlOKSB7CiAgICAgICAgICAgICAgbWluX3ZhbHVlW2NoYW5uZWxdID0gSU5UOF9NSU47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoc2FtcGxlID4gbWF4X3ZhbHVlW2NoYW5uZWxdKSB7CiAgICAgICAgICAgIG1heF92YWx1ZVtjaGFubmVsXSA9IHNhbXBsZTsKCiAgICAgICAgICAgIGlmIChtYXhfdmFsdWVbY2hhbm5lbF0gPiBJTlQ4X01BWCkgewogICAgICAgICAgICAgIG1heF92YWx1ZVtjaGFubmVsXSA9IElOVDhfTUFYOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoKytzY2FsZV9jb3VudGVyID09PSBzY2FsZSkgewogICAgICAgIGZvciAoY2hhbm5lbCA9IDA7IGNoYW5uZWwgPCBvdXRwdXRfY2hhbm5lbHM7IGNoYW5uZWwrKykgewogICAgICAgICAgZGF0YV92aWV3LnNldEludDgob2Zmc2V0KyssIG1pbl92YWx1ZVtjaGFubmVsXSk7CiAgICAgICAgICBkYXRhX3ZpZXcuc2V0SW50OChvZmZzZXQrKywgbWF4X3ZhbHVlW2NoYW5uZWxdKTsKICAgICAgICAgIG1pbl92YWx1ZVtjaGFubmVsXSA9IEluZmluaXR5OwogICAgICAgICAgbWF4X3ZhbHVlW2NoYW5uZWxdID0gLUluZmluaXR5OwogICAgICAgIH0KCiAgICAgICAgc2NhbGVfY291bnRlciA9IDA7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoc2NhbGVfY291bnRlciA+IDApIHsKICAgICAgZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IG91dHB1dF9jaGFubmVsczsgY2hhbm5lbCsrKSB7CiAgICAgICAgZGF0YV92aWV3LnNldEludDgob2Zmc2V0KyssIG1pbl92YWx1ZVtjaGFubmVsXSk7CiAgICAgICAgZGF0YV92aWV3LnNldEludDgob2Zmc2V0KyssIG1heF92YWx1ZVtjaGFubmVsXSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYnVmZmVyOwogIH0KCiAgb25tZXNzYWdlID0gZnVuY3Rpb24gb25tZXNzYWdlKGV2dCkgewogICAgdmFyIGJ1ZmZlciA9IGdlbmVyYXRlV2F2ZWZvcm1EYXRhKGV2dC5kYXRhKTsgLy8gVHJhbnNmZXIgYnVmZmVyIHRvIHRoZSBjYWxsaW5nIHRocmVhZAoKICAgIHRoaXMucG9zdE1lc3NhZ2UoYnVmZmVyLCBbYnVmZmVyXSk7CiAgICB0aGlzLmNsb3NlKCk7CiAgfTsKCn0pKCk7Cgo=",h=null,c=!1,o?l(I,h,c):function(t,e,n){var a;return function(s){return a=a||i(t,e,n),new Worker(a,s)}}(I,h,c));function A(e){if(function(t){return t&&"object"===s(t)&&"sample_rate"in t&&"samples_per_pixel"in t&&"bits"in t&&"length"in t&&"data"in t}(e)&&(e=function(t){var e=t.data,n=t.channels||1,a=8===t.bits?1:2,s=2*t.length*n;if(e.length!==s)throw new Error("WaveformData.create(): Length mismatch in JSON waveform data");var r=24+e.length*a,g=new ArrayBuffer(r),l=new DataView(g);l.setInt32(0,2,!0),l.setUint32(4,8===t.bits,!0),l.setInt32(8,t.sample_rate,!0),l.setInt32(12,t.samples_per_pixel,!0),l.setInt32(16,t.length,!0),l.setInt32(20,n,!0);var i,o=24;if(8===t.bits)for(i=0;i<e.length;i++)l.setInt8(o++,e[i],!0);else for(i=0;i<e.length;i++)l.setInt16(o,e[i],!0),o+=2;return g}(e)),!function(t){var e=t&&"object"===s(t)&&"byteLength"in t;if(e){var n=new DataView(t).getInt32(0,!0);if(1!==n&&2!==n)throw new TypeError("WaveformData.create(): This waveform data version not supported")}return e}(e))throw new TypeError("WaveformData.create(): Unknown data format");this._data=new DataView(e),this._offset=2===this._version()?24:20,this._channels=[];for(var n=0;n<this.channels;n++)this._channels[n]=new t(this,n)}var u=512,m=1,f=!1,b=!1;function d(t,e,n){var s=function(t){for(var e=[],n=0;n<t.numberOfChannels;++n)e.push(t.getChannelData(n).buffer);return e}(t);if(e.disable_worker){var r=a({scale:e.scale,amplitude_scale:e.amplitude_scale,split_channels:e.split_channels,length:t.length,sample_rate:t.sampleRate,channels:s});n(null,new A(r),t)}else{var g=new C;g.onmessage=function(e){n(null,new A(e.data),t)},g.postMessage({scale:e.scale,amplitude_scale:e.amplitude_scale,split_channels:e.split_channels,length:t.length,sample_rate:t.sampleRate,channels:s},s)}}return A.create=function(t){return new A(t)},A.createFromAudio=function(t,e){var n=function(t){return{scale:t.scale||u,amplitude_scale:t.amplitude_scale||m,split_channels:t.split_channels||f,disable_worker:t.disable_worker||b}}(t);if(t.audio_context&&t.array_buffer)return function(t,e,n,a){t.decodeAudioData(e,(function(t){d(t,n,a)}),(function(t){t||(t=new DOMException("EncodingError")),a(t)}))}(t.audio_context,t.array_buffer,n,e);if(t.audio_buffer)return d(t.audio_buffer,n,e);throw new TypeError("WaveformData.createFromAudio(): Pass either an AudioContext and ArrayBuffer, or an AudioBuffer object")},A.prototype={resample:function(t){if(t.scale="number"==typeof t.scale?t.scale:null,t.width="number"==typeof t.width?t.width:null,null!=t.width&&t.width<=0)throw new RangeError("WaveformData.resample(): width should be a positive integer value");if(null!=t.scale&&t.scale<=0)throw new RangeError("WaveformData.resample(): scale should be a positive integer value");if(!t.scale&&!t.width)throw new Error("WaveformData.resample(): Missing scale or width option");var e=t.scale||Math.floor(this.duration*this.sample_rate/t.width),n=this.scale,a=this.length,s=a*this.scale,r=Math.ceil(s/e),g=8===this.bits?1:2,l=24+2*r*this.channels*g,i=new ArrayBuffer(l),o=new DataView(i);o.setInt32(0,2,!0),o.setUint32(4,8===this.bits,!0),o.setInt32(8,this.sample_rate,!0),o.setInt32(12,e,!0),o.setInt32(16,r,!0),o.setInt32(20,this.channels,!0);var I,h=new A(i),c=0,C=0,u=this.channels,m=new Array(u),f=new Array(u);for(I=0;I<u;++I)a>0?(m[I]=this.channel(I).min_sample(c),f[I]=this.channel(I).max_sample(c)):(m[I]=0,f[I]=0);var b,d,p,W,V=8===this.bits?-128:-32768,w=8===this.bits?127:32767;if(e<n)throw new Error("WaveformData.resample(): Zoom level "+e+" too low, minimum: "+n);function Z(t){return Math.floor(t*e)}for(;c<a;){for(;Math.floor(Z(C)/n)===c;){if(C>0)for(I=0;I<u;++I)h.channel(I).set_min_sample(C-1,m[I]),h.channel(I).set_max_sample(C-1,f[I]);if(W=c,(b=Z(++C))!==Z(C-1))for(I=0;I<u;++I)m[I]=w,f[I]=V}for(b=Z(C),(d=Math.floor(b/n))>a&&(d=a);c<d;){for(I=0;I<u;++I)(p=this.channel(I).min_sample(c))<m[I]&&(m[I]=p),(p=this.channel(I).max_sample(c))>f[I]&&(f[I]=p);c++}}if(c!==W)for(I=0;I<u;++I)h.channel(I).set_min_sample(C-1,m[I]),h.channel(I).set_max_sample(C-1,f[I]);return h},concat:function(){var t=this,e=Array.prototype.slice.call(arguments);e.forEach((function(e){if(t.channels!==e.channels||t.sample_rate!==e.sample_rate||t.bits!==e.bits||t.scale!==e.scale)throw new Error("WaveformData.concat(): Waveforms are incompatible")}));var n=this._concatBuffers.apply(this,e);return A.create(n)},_concatBuffers:function(){var t,e,n=Array.prototype.slice.call(arguments),a=this._offset,s=a,r=0,g=[this].concat(n).map((function(t){return t._data.buffer}));for(t=0;t<g.length;t++){e=g[t];var l=new DataView(e).getInt32(16,!0);s+=e.byteLength-a,r+=l}var i=new ArrayBuffer(s),o=new DataView(g[0]),I=new DataView(i);for(t=0;t<a;t++)I.setUint8(t,o.getUint8(t));I.setInt32(16,r,!0);var h=0,c=new Uint8Array(i,a);for(t=0;t<g.length;t++)e=g[t],c.set(new Uint8Array(e,a),h),h+=e.byteLength-a;return i},_offsetValues:function(t,e,n){var a=[],s=this.channels;n+=t*s*2;for(var r=0;r<e;r++)a.push(this._at(r*s*2+n));return a},_version:function(){return this._data.getInt32(0,!0)},get length(){return this._data.getUint32(16,!0)},get bits(){return Boolean(this._data.getUint32(4,!0))?8:16},get duration(){return this.length*this.scale/this.sample_rate},get pixels_per_second(){return this.sample_rate/this.scale},get seconds_per_pixel(){return this.scale/this.sample_rate},get channels(){return 2===this._version()?this._data.getInt32(20,!0):1},channel:function(t){if(t>=0&&t<this._channels.length)return this._channels[t];throw new RangeError("Invalid channel: "+t)},get sample_rate(){return this._data.getInt32(8,!0)},get scale(){return this._data.getInt32(12,!0)},_at:function(t){return 8===this.bits?this._data.getInt8(this._offset+t):this._data.getInt16(this._offset+2*t,!0)},_set_at:function(t,e){return 8===this.bits?this._data.setInt8(this._offset+t,e):this._data.setInt16(this._offset+2*t,e,!0)},at_time:function(t){return Math.floor(t*this.sample_rate/this.scale)},time:function(t){return t*this.scale/this.sample_rate},toJSON:function(){for(var t={version:2,channels:this.channels,sample_rate:this.sample_rate,samples_per_pixel:this.scale,bits:this.bits,length:this.length,data:[]},e=0;e<this.length;e++)for(var n=0;n<this.channels;n++)t.data.push(this.channel(n).min_sample(e)),t.data.push(this.channel(n).max_sample(e));return t},toArrayBuffer:function(){return this._data.buffer}},A}));
//# sourceMappingURL=waveform-data.min.js.map
